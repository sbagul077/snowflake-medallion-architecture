create or replace database FINAL_ASSIGNMENT;

create or replace schema FINAL_ASSIGNMENT.CCDA;

create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_ALLERGIES (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	SUBSTANCE_DESC VARCHAR(16777216),
	SUBSTANCE_CODE_SYSTEM VARCHAR(16777216),
	SUBSTANCE_CODE VARCHAR(16777216),
	REACTION_DESC VARCHAR(16777216),
	REACTION_CODE_SYSTEM VARCHAR(16777216),
	REACTION_CODE VARCHAR(16777216),
	SEVERITY VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_BRONZE (
	FILE_NAME VARCHAR(16777216),
	DOC VARIANT,
	LOAD_TS TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_ENCOUNTERS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_FUNCTIONAL_STATUS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	VALUE VARCHAR(16777216),
	UNIT VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_IMMUNIZATIONS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_INGEST_MANIFEST (
	FILE_NAME VARCHAR(16777216),
	STATUS VARCHAR(16777216),
	REASON VARCHAR(16777216),
	COUNT_MEDICATIONS NUMBER(38,0),
	COUNT_VITALS NUMBER(38,0),
	COUNT_RESULTS NUMBER(38,0),
	COUNT_PROBLEMS NUMBER(38,0),
	COUNT_PROCEDURES NUMBER(38,0),
	COUNT_ENCOUNTERS NUMBER(38,0),
	COUNT_IMMUNIZATIONS NUMBER(38,0),
	COUNT_FUNCTIONAL_STATUS NUMBER(38,0),
	COUNT_ALLERGIES NUMBER(38,0),
	COUNT_PLAN_OF_CARE NUMBER(38,0),
	COUNT_SOCIAL_HISTORY NUMBER(38,0),
	PROCESSED_AT TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_MEDICATIONS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_PLAN_OF_CARE (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_PROBLEMS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_PROCEDURES (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_RESULTS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	VALUE VARCHAR(16777216),
	UNIT VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_SOCIAL_HISTORY (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	STOP_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	STOP_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	VALUE VARCHAR(16777216),
	UNIT VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.CCDA.CCDA_VITALS (
	FILE_NAME VARCHAR(16777216),
	START_RAW VARCHAR(16777216),
	START_ISO TIMESTAMP_NTZ(9),
	DESCRIPTION VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	CODE VARCHAR(16777216),
	VALUE VARCHAR(16777216),
	UNIT VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	DOCUMENT_ID VARCHAR(16777216),
	PATIENT_IDS_ALL VARIANT,
	SOURCE_SYSTEM VARCHAR(16777216),
	RECORD_TYPE VARCHAR(16777216)
);
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.CCDA.FF_XML
	TYPE = XML
	DISABLE_AUTO_CONVERT = TRUE
;
create or replace schema FINAL_ASSIGNMENT.CSV;

create or replace TABLE FINAL_ASSIGNMENT.CSV.ALLERGIES (
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	SYSTEM VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	TYPE VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	REACTION1 VARCHAR(16777216),
	DESCRIPTION1 VARCHAR(16777216),
	SEVERITY1 VARCHAR(16777216),
	REACTION2 VARCHAR(16777216),
	DESCRIPTION2 VARCHAR(16777216),
	SEVERITY2 VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.CAREPLANS (
	ID VARCHAR(16777216),
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	REASONCODE VARCHAR(16777216),
	REASONDESCRIPTION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.CLAIMS (
	ID VARCHAR(16777216),
	PATIENTID VARCHAR(16777216),
	PROVIDERID VARCHAR(16777216),
	PRIMARYPATIENTINSURANCEID VARCHAR(16777216),
	SECONDARYPATIENTINSURANCEID VARCHAR(16777216),
	DEPARTMENTID VARCHAR(16777216),
	PATIENTDEPARTMENTID VARCHAR(16777216),
	DIAGNOSIS1 VARCHAR(16777216),
	DIAGNOSIS2 VARCHAR(16777216),
	DIAGNOSIS3 VARCHAR(16777216),
	DIAGNOSIS4 VARCHAR(16777216),
	DIAGNOSIS5 VARCHAR(16777216),
	DIAGNOSIS6 VARCHAR(16777216),
	DIAGNOSIS7 VARCHAR(16777216),
	DIAGNOSIS8 VARCHAR(16777216),
	REFERRINGPROVIDERID VARCHAR(16777216),
	APPOINTMENTID VARCHAR(16777216),
	CURRENTILLNESSDATE VARCHAR(16777216),
	SERVICEDATE VARCHAR(16777216),
	SUPERVISINGPROVIDERID VARCHAR(16777216),
	STATUS1 VARCHAR(16777216),
	STATUS2 VARCHAR(16777216),
	STATUSP VARCHAR(16777216),
	OUTSTANDING1 VARCHAR(16777216),
	OUTSTANDING2 VARCHAR(16777216),
	OUTSTANDINGP VARCHAR(16777216),
	LASTBILLEDDATE1 VARCHAR(16777216),
	LASTBILLEDDATE2 VARCHAR(16777216),
	LASTBILLEDDATEP VARCHAR(16777216),
	HEALTHCARECLAIMTYPEID1 VARCHAR(16777216),
	HEALTHCARECLAIMTYPEID2 VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.CLAIMS_TRANSACTIONS (
	ID VARCHAR(16777216),
	CLAIMID VARCHAR(16777216),
	CHARGEID VARCHAR(16777216),
	PATIENTID VARCHAR(16777216),
	TYPE VARCHAR(16777216),
	AMOUNT VARCHAR(16777216),
	METHOD VARCHAR(16777216),
	FROMDATE VARCHAR(16777216),
	TODATE VARCHAR(16777216),
	PLACEOFSERVICE VARCHAR(16777216),
	PROCEDURECODE VARCHAR(16777216),
	MODIFIER1 VARCHAR(16777216),
	MODIFIER2 VARCHAR(16777216),
	DIAGNOSISREF1 VARCHAR(16777216),
	DIAGNOSISREF2 VARCHAR(16777216),
	DIAGNOSISREF3 VARCHAR(16777216),
	DIAGNOSISREF4 VARCHAR(16777216),
	UNITS VARCHAR(16777216),
	DEPARTMENTID VARCHAR(16777216),
	NOTES VARCHAR(16777216),
	UNITAMOUNT VARCHAR(16777216),
	TRANSFEROUTID VARCHAR(16777216),
	TRANSFERTYPE VARCHAR(16777216),
	PAYMENTS VARCHAR(16777216),
	ADJUSTMENTS VARCHAR(16777216),
	TRANSFERS VARCHAR(16777216),
	OUTSTANDING VARCHAR(16777216),
	APPOINTMENTID VARCHAR(16777216),
	LINENOTE VARCHAR(16777216),
	PATIENTINSURANCEID VARCHAR(16777216),
	FEESCHEDULEID VARCHAR(16777216),
	PROVIDERID VARCHAR(16777216),
	SUPERVISINGPROVIDERID VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.CONDITIONS (
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.DEVICES (
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	UDI VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.ENCOUNTERS (
	ID VARCHAR(16777216),
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ORGANIZATION VARCHAR(16777216),
	PROVIDER VARCHAR(16777216),
	PAYER VARCHAR(16777216),
	ENCOUNTERCLASS VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	BASE_ENCOUNTER_COST VARCHAR(16777216),
	TOTAL_CLAIM_COST VARCHAR(16777216),
	PAYER_COVERAGE VARCHAR(16777216),
	REASONCODE VARCHAR(16777216),
	REASONDESCRIPTION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.IMAGING_STUDIES (
	ID VARCHAR(16777216),
	DATE VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	SERIES_UID VARCHAR(16777216),
	BODYSITE_CODE VARCHAR(16777216),
	BODYSITE_DESCRIPTION VARCHAR(16777216),
	MODALITY_CODE VARCHAR(16777216),
	MODALITY_DESCRIPTION VARCHAR(16777216),
	INSTANCE_UID VARCHAR(16777216),
	SOP_CODE VARCHAR(16777216),
	SOP_DESCRIPTION VARCHAR(16777216),
	PROCEDURE_CODE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.IMMUNIZATIONS (
	DATE VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	BASE_COST VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.MEDICATIONS (
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	PAYER VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	BASE_COST VARCHAR(16777216),
	PAYER_COVERAGE VARCHAR(16777216),
	DISPENSES VARCHAR(16777216),
	TOTALCOST VARCHAR(16777216),
	REASONCODE VARCHAR(16777216),
	REASONDESCRIPTION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.OBSERVATIONS (
	DATE VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	VALUE VARCHAR(16777216),
	UNITS VARCHAR(16777216),
	TYPE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.ORGANIZATIONS (
	ID VARCHAR(16777216),
	NAME VARCHAR(16777216),
	ADDRESS VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	ZIP VARCHAR(16777216),
	LAT VARCHAR(16777216),
	LON VARCHAR(16777216),
	PHONE VARCHAR(16777216),
	REVENUE VARCHAR(16777216),
	UTILIZATION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.PATIENTS (
	ID VARCHAR(16777216),
	BIRTHDATE VARCHAR(16777216),
	DEATHDATE VARCHAR(16777216),
	SSN VARCHAR(16777216),
	DRIVERS VARCHAR(16777216),
	PASSPORT VARCHAR(16777216),
	PREFIX VARCHAR(16777216),
	FIRST_NAME VARCHAR(16777216),
	LAST_NAME VARCHAR(16777216),
	SUFFIX VARCHAR(16777216),
	MAIDEN VARCHAR(16777216),
	MARITAL VARCHAR(16777216),
	RACE VARCHAR(16777216),
	ETHNICITY VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	BIRTHPLACE VARCHAR(16777216),
	ADDRESS VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	COUNTY VARCHAR(16777216),
	FIPS VARCHAR(16777216),
	ZIP VARCHAR(16777216),
	LAT VARCHAR(16777216),
	LON VARCHAR(16777216),
	HEALTHCARE_EXPENSES VARCHAR(16777216),
	HEALTHCARE_COVERAGE VARCHAR(16777216),
	INCOME VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.PAYERS (
	ID VARCHAR(16777216),
	NAME VARCHAR(16777216),
	OWNERSHIP VARCHAR(16777216),
	ADDRESS VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE_HEADQUARTERED VARCHAR(16777216),
	ZIP VARCHAR(16777216),
	PHONE VARCHAR(16777216),
	AMOUNT_COVERED VARCHAR(16777216),
	AMOUNT_UNCOVERED VARCHAR(16777216),
	REVENUE VARCHAR(16777216),
	COVERED_ENCOUNTERS VARCHAR(16777216),
	UNCOVERED_ENCOUNTERS VARCHAR(16777216),
	COVERED_MEDICATIONS VARCHAR(16777216),
	UNCOVERED_MEDICATIONS VARCHAR(16777216),
	COVERED_PROCEDURES VARCHAR(16777216),
	UNCOVERED_PROCEDURES VARCHAR(16777216),
	COVERED_IMMUNIZATIONS VARCHAR(16777216),
	UNCOVERED_IMMUNIZATIONS VARCHAR(16777216),
	UNIQUE_CUSTOMERS VARCHAR(16777216),
	QOLS_AVG VARCHAR(16777216),
	MEMBER_MONTHS VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.PAYER_TRANSITIONS (
	PATIENT VARCHAR(16777216),
	MEMBERID VARCHAR(16777216),
	START_DATE VARCHAR(16777216),
	END_DATE VARCHAR(16777216),
	PAYER VARCHAR(16777216),
	SECONDARY_PAYER VARCHAR(16777216),
	PLAN_OWNERSHIP VARCHAR(16777216),
	OWNER_NAME VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.PROCEDURES (
	"START" VARCHAR(16777216),
	STOP VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	BASE_COST VARCHAR(16777216),
	REASONCODE VARCHAR(16777216),
	REASONDESCRIPTION VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.PROVIDERS (
	ID VARCHAR(16777216),
	ORGANIZATION VARCHAR(16777216),
	NAME VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	SPECIALITY VARCHAR(16777216),
	ADDRESS VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	ZIP VARCHAR(16777216),
	LAT VARCHAR(16777216),
	LON VARCHAR(16777216),
	ENCOUNTERS VARCHAR(16777216),
	PROCEDURES VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_ALLERGIES (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_CAREPLANS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_CLAIMS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_CLAIMS_TRANSACTIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_CONDITIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_DEVICES (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_ENCOUNTERS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_IMAGING_STUDIES (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_IMMUNIZATIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_MEDICATIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_OBSERVATIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_ORGANIZATIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_PATIENTS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_PAYERS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_PAYER_TRANSITIONS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_PROCEDURES (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_PROVIDERS (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.RAW_SUPPLIES (
	RAW_LINE VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
create or replace TABLE FINAL_ASSIGNMENT.CSV.SUPPLIES (
	DATE VARCHAR(16777216),
	PATIENT VARCHAR(16777216),
	ENCOUNTER VARCHAR(16777216),
	CODE VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	QUANTITY VARCHAR(16777216),
	SRC_FILENAME VARCHAR(16777216),
	SRC_ROW_NUMBER NUMBER(38,0)
);
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.CSV.FF_CSV
	SKIP_HEADER = 1
	TRIM_SPACE = TRUE
	FIELD_OPTIONALLY_ENCLOSED_BY = '\"'
	NULL_IF = ('NULL')
;
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.CSV.FF_RAW
	FIELD_DELIMITER = '\t'
;
CREATE OR REPLACE FUNCTION FINAL_ASSIGNMENT.CSV.PARSE_CSV_LINE("LINE" VARCHAR)
RETURNS VARIANT
LANGUAGE PYTHON
RUNTIME_VERSION = '3.12'
HANDLER = 'parse'
AS '
import csv, io

def parse(line):
    # csv.reader handles quoted fields and embedded commas
    row = next(csv.reader(io.StringIO(line)))
    # Trim whitespace just in case
    return [s.strip() if isinstance(s, str) else s for s in row]
';
create or replace schema FINAL_ASSIGNMENT.DIM;

create or replace TABLE FINAL_ASSIGNMENT.DIM.DIM_CODE_ALLERGEN (
	ALLERGEN_SK NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 noorder,
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	IS_ACTIVE BOOLEAN DEFAULT TRUE,
	primary key (ALLERGEN_SK)
);
create or replace TABLE FINAL_ASSIGNMENT.DIM.MAP_ALLERGEN_IUIS_TO_STD (
	IUIS_CODE_TEXT VARCHAR(16777216),
	NORMALIZED_DISPLAY VARCHAR(16777216),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	NOTES VARCHAR(16777216)
);
create or replace view FINAL_ASSIGNMENT.DIM.V_HL7_IUIS_NORMALIZED(
	MESSAGE_ID,
	PATIENT_ID,
	IUIS_CODE_TEXT,
	NORMALIZED_DISPLAY
) as
SELECT
  a.MESSAGE_ID,
  a.PATIENT_ID,
  a.ALLERGEN_CODE AS IUIS_CODE_TEXT,
  COALESCE(m.NORMALIZED_DISPLAY,
    CASE
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Der\\s?[fp]\\s?\\d', 'i') THEN 'House dust mite (organism)'
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Ara\\s?h\\s?\\d', 'i')   THEN 'Peanut (substance)'
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Can\\s?f\\s?\\d', 'i')   THEN 'Animal dander (substance)'
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Jug\\s?r\\s?\\d', 'i')   THEN 'Tree nut (substance)'
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Che\\s?a\\s?\\d', 'i')   THEN 'Tree nut (substance)'
      WHEN REGEXP_LIKE(a.ALLERGEN_CODE, '^Pen\\s?n\\s?\\d', 'i')   THEN 'Mold (organism)'
      ELSE 'Allergy to substance (finding)'
    END
  ) AS NORMALIZED_DISPLAY
FROM HL7.HL7_BRONZE_AL1 a
LEFT JOIN DIM.MAP_ALLERGEN_IUIS_TO_STD m
  ON LOWER(m.IUIS_CODE_TEXT) = LOWER(a.ALLERGEN_CODE);
create or replace schema FINAL_ASSIGNMENT.HL7;

create or replace TABLE FINAL_ASSIGNMENT.HL7.DIM_CODE_ALLERGEN (
	ALLERGEN_SK NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 noorder,
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	IS_ACTIVE BOOLEAN DEFAULT TRUE,
	primary key (ALLERGEN_SK)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.FACT_ALLERGY_EVENT (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.FACT_ALLERGY_EVENT_CSV (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.FACT_ALLERGY_EVENT_CSV_RAW (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	ALLERGEN_RAW VARCHAR(16777216),
	CATEGORY_RAW VARCHAR(16777216),
	SEVERITY_RAW VARCHAR(16777216),
	REACTION_TEXT VARCHAR(16777216),
	SYSTEM_CODE VARCHAR(16777216),
	SYSTEM_NAME VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.FACT_ALLERGY_EVENT_HL7 (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.FACT_ALLERGY_EVENT_HL7_RAW (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	ALLERGEN_RAW VARCHAR(16777216),
	CATEGORY_RAW VARCHAR(16777216),
	SEVERITY_RAW VARCHAR(16777216),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_AL1 (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID VARCHAR(16777216),
	ALLERGY_TYPE_RAW VARCHAR(16777216),
	ALLERGY_TYPE_CODE VARCHAR(16777216),
	ALLERGY_TYPE_DESC VARCHAR(16777216),
	ALLERGEN_RAW VARCHAR(16777216),
	ALLERGEN_CODE VARCHAR(16777216),
	ALLERGEN_TEXT VARCHAR(16777216),
	ALLERGEN_CODE_SYSTEM VARCHAR(16777216),
	SEVERITY_RAW VARCHAR(16777216),
	SEVERITY_CODE VARCHAR(16777216),
	SEVERITY_DESC VARCHAR(16777216),
	REACTION_RAW VARCHAR(16777216),
	REACTION_FIRST VARCHAR(16777216),
	REACTION_LIST VARCHAR(16777216),
	ID_DT_RAW VARCHAR(16777216),
	ID_DT_TZ TIMESTAMP_TZ(9),
	ID_DT_NTZ TIMESTAMP_NTZ(9),
	ID_DT_DATE DATE,
	PATIENT_ID_LIST VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	PATIENT_ID_TYPE VARCHAR(16777216),
	PATIENT_ID_AUTH VARCHAR(16777216),
	PATIENT_ID_FACILITY VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_DG1 (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID VARCHAR(16777216),
	CODING_METHOD VARCHAR(16777216),
	DIAGNOSIS_RAW VARCHAR(16777216),
	DIAGNOSIS_CODE VARCHAR(16777216),
	DIAGNOSIS_TEXT VARCHAR(16777216),
	DIAGNOSIS_SYSTEM VARCHAR(16777216),
	DIAGNOSIS_DESC VARCHAR(16777216),
	DIAGNOSIS_DT_RAW VARCHAR(16777216),
	DIAGNOSIS_DT_TZ TIMESTAMP_TZ(9),
	DIAGNOSIS_DT_NTZ TIMESTAMP_NTZ(9),
	DIAGNOSIS_DT_DATE DATE,
	DIAGNOSIS_TYPE VARCHAR(16777216),
	DIAGNOSIS_PRIORITY VARCHAR(16777216),
	PATIENT_ID_LIST VARCHAR(16777216),
	PATIENT_ID VARCHAR(16777216),
	PATIENT_ID_TYPE VARCHAR(16777216),
	PATIENT_ID_AUTH VARCHAR(16777216),
	PATIENT_ID_FACILITY VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_EVN (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	EVENT_TYPE_CODE VARCHAR(16777216),
	RECORDED_DT_RAW VARCHAR(16777216),
	RECORDED_DT_TZ TIMESTAMP_TZ(9),
	PLANNED_DT_RAW VARCHAR(16777216),
	PLANNED_DT_TZ TIMESTAMP_TZ(9),
	EVENT_REASON_CODE VARCHAR(16777216),
	OPERATOR_ID_RAW VARCHAR(16777216),
	EVENT_OCCURRED_RAW VARCHAR(16777216),
	EVENT_OCCURRED_TZ TIMESTAMP_TZ(9),
	EVENT_FACILITY VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_GT1 (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID VARCHAR(16777216),
	GUARANTOR_NAME_RAW VARCHAR(16777216),
	GUARANTOR_LAST_NAME VARCHAR(16777216),
	GUARANTOR_FIRST_NAME VARCHAR(16777216),
	GUARANTOR_MIDDLE_NAME VARCHAR(16777216),
	GUARANTOR_ADDRESS_RAW VARCHAR(16777216),
	GUARANTOR_STREET_1 VARCHAR(16777216),
	GUARANTOR_STREET_2 VARCHAR(16777216),
	GUARANTOR_CITY VARCHAR(16777216),
	GUARANTOR_STATE VARCHAR(16777216),
	GUARANTOR_POSTAL VARCHAR(16777216),
	GUARANTOR_PHONE_HOME VARCHAR(16777216),
	GUARANTOR_PHONE_BUSINESS VARCHAR(16777216),
	GUARANTOR_DOB_RAW VARCHAR(16777216),
	GUARANTOR_DOB_TZ TIMESTAMP_TZ(9),
	GUARANTOR_SEX VARCHAR(16777216),
	GUARANTOR_RELATIONSHIP VARCHAR(16777216),
	GUARANTOR_SSN VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_IN1 (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID VARCHAR(16777216),
	PLAN_ID_RAW VARCHAR(16777216),
	PLAN_ID_CODE VARCHAR(16777216),
	PLAN_ID_DESC VARCHAR(16777216),
	COMPANY_ID_RAW VARCHAR(16777216),
	COMPANY_ID_CODE VARCHAR(16777216),
	COMPANY_ID_DESC VARCHAR(16777216),
	COMPANY_NAME VARCHAR(16777216),
	COMPANY_ADDRESS_RAW VARCHAR(16777216),
	COMPANY_STREET_1 VARCHAR(16777216),
	COMPANY_STREET_2 VARCHAR(16777216),
	COMPANY_CITY VARCHAR(16777216),
	COMPANY_STATE VARCHAR(16777216),
	COMPANY_POSTAL VARCHAR(16777216),
	COMPANY_CONTACT_PERSON VARCHAR(16777216),
	COMPANY_PHONE VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	PLAN_TYPE_RAW VARCHAR(16777216),
	PLAN_TYPE_CODE VARCHAR(16777216),
	PLAN_TYPE_DESC VARCHAR(16777216),
	INSURED_NAME_RAW VARCHAR(16777216),
	INSURED_LAST_NAME VARCHAR(16777216),
	INSURED_FIRST_NAME VARCHAR(16777216),
	INSURED_MIDDLE_NAME VARCHAR(16777216),
	INSURED_RELATIONSHIP VARCHAR(16777216),
	INSURED_DOB_RAW VARCHAR(16777216),
	INSURED_DOB_TZ TIMESTAMP_TZ(9),
	INSURED_ADDRESS_RAW VARCHAR(16777216),
	INSURED_STREET_1 VARCHAR(16777216),
	INSURED_STREET_2 VARCHAR(16777216),
	INSURED_CITY VARCHAR(16777216),
	INSURED_STATE VARCHAR(16777216),
	INSURED_POSTAL VARCHAR(16777216),
	ASSIGN_BENEFITS VARCHAR(16777216),
	COORDINATION_OF_BENEFITS VARCHAR(16777216),
	NOTICE_ADMISSION_DT_RAW VARCHAR(16777216),
	NOTICE_ADMISSION_DT_TZ TIMESTAMP_TZ(9)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_NTE (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID_NTE VARCHAR(16777216),
	SOURCE_OF_COMMENT VARCHAR(16777216),
	COMMENT_TEXT VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_OBR (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	PLACER_ORDER_NUM VARCHAR(16777216),
	FILLER_ORDER_NUM VARCHAR(16777216),
	UNIVERSAL_SERVICE_RAW VARCHAR(16777216),
	SERVICE_CODE VARCHAR(16777216),
	SERVICE_TEXT VARCHAR(16777216),
	SERVICE_CODE_SYSTEM VARCHAR(16777216),
	OBS_DT_RAW VARCHAR(16777216),
	OBS_DT_TZ TIMESTAMP_TZ(9),
	ORDERING_PROVIDER_RAW VARCHAR(16777216),
	ORDERING_PROVIDER_ID VARCHAR(16777216),
	ORDERING_PROVIDER_LAST_NAME VARCHAR(16777216),
	ORDERING_PROVIDER_FIRST_NAME VARCHAR(16777216),
	OBR_STATUS_RAW VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_OBX (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	VALUE_TYPE VARCHAR(16777216),
	OBSERVATION_ID_RAW VARCHAR(16777216),
	OBSERVATION_CODE VARCHAR(16777216),
	OBSERVATION_TEXT VARCHAR(16777216),
	OBSERVATION_CODE_SYSTEM VARCHAR(16777216),
	OBSERVATION_SUB_ID VARCHAR(16777216),
	OBSERVATION_VALUE VARCHAR(16777216),
	UNITS_RAW VARCHAR(16777216),
	REFERENCE_RANGE VARCHAR(16777216),
	ABNORMAL_FLAGS VARCHAR(16777216),
	OBX_STATUS_RAW VARCHAR(16777216),
	OBSERVATION_RESULT_DT_RAW VARCHAR(16777216),
	OBSERVATION_RESULT_DT_TZ TIMESTAMP_TZ(9)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_ORC (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	ORDER_CONTROL VARCHAR(16777216),
	PLACER_ORDER_NUM VARCHAR(16777216),
	FILLER_ORDER_NUM VARCHAR(16777216),
	QTY_TIMING_RAW VARCHAR(16777216),
	ORDER_DT_RAW VARCHAR(16777216),
	ORDER_DT_TZ TIMESTAMP_TZ(9),
	ORDERING_PROVIDER_RAW VARCHAR(16777216),
	ORDERING_PROVIDER_ID VARCHAR(16777216),
	ORDERING_PROVIDER_LAST_NAME VARCHAR(16777216),
	ORDERING_PROVIDER_FIRST_NAME VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_PID (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	PATIENT_ID_LIST VARCHAR(16777216),
	PATIENT_NAME_RAW VARCHAR(16777216),
	LAST_NAME VARCHAR(16777216),
	FIRST_NAME VARCHAR(16777216),
	MIDDLE_NAME VARCHAR(16777216),
	DOB_RAW VARCHAR(16777216),
	DOB_DATE DATE,
	DOB_TS_NTZ TIMESTAMP_NTZ(9),
	DOB_TS_TZ TIMESTAMP_TZ(9),
	SEX VARCHAR(16777216),
	ADDRESS_RAW VARCHAR(16777216),
	STREET_1 VARCHAR(16777216),
	STREET_2 VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	POSTAL_CODE VARCHAR(16777216),
	COUNTRY VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_PV1 (
	MESSAGE_ID VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	PROCESS_TS TIMESTAMP_LTZ(9),
	SET_ID VARCHAR(16777216),
	PATIENT_CLASS VARCHAR(16777216),
	ADMISSION_TYPE VARCHAR(16777216),
	PREADMIT_NUMBER VARCHAR(16777216),
	PATIENT_TYPE VARCHAR(16777216),
	VIP_INDICATOR VARCHAR(16777216),
	ASSIGNED_LOCATION_RAW VARCHAR(16777216),
	LOC_POINT_OF_CARE VARCHAR(16777216),
	LOC_ROOM_RAW VARCHAR(16777216),
	LOC_ROOM VARCHAR(16777216),
	LOC_ROOM_NUMERIC NUMBER(38,0),
	LOC_FACILITY VARCHAR(16777216),
	LOC_BUILDING VARCHAR(16777216),
	LOC_FLOOR VARCHAR(16777216),
	LOC_DESCRIPTION VARCHAR(16777216),
	PRIOR_LOCATION_RAW VARCHAR(16777216),
	PRIOR_POINT_OF_CARE VARCHAR(16777216),
	PRIOR_ROOM VARCHAR(16777216),
	PRIOR_FACILITY VARCHAR(16777216),
	ATTENDING_RAW VARCHAR(16777216),
	ATTENDING_ID VARCHAR(16777216),
	ATTENDING_LAST_NAME VARCHAR(16777216),
	ATTENDING_FIRST_NAME VARCHAR(16777216),
	REFERRING_RAW VARCHAR(16777216),
	REFERRING_ID VARCHAR(16777216),
	REFERRING_LAST_NAME VARCHAR(16777216),
	REFERRING_FIRST_NAME VARCHAR(16777216),
	CONSULTING_RAW VARCHAR(16777216),
	CONSULTING_ID VARCHAR(16777216),
	CONSULTING_LAST_NAME VARCHAR(16777216),
	CONSULTING_FIRST_NAME VARCHAR(16777216),
	ADMITTING_RAW VARCHAR(16777216),
	ADMITTING_ID VARCHAR(16777216),
	ADMITTING_LAST_NAME VARCHAR(16777216),
	ADMITTING_FIRST_NAME VARCHAR(16777216),
	HOSPITAL_SERVICE_RAW VARCHAR(16777216),
	HOSPITAL_SERVICE_CODE VARCHAR(16777216),
	HOSPITAL_SERVICE_DESC VARCHAR(16777216),
	VISIT_NUMBER_RAW VARCHAR(16777216),
	VISIT_NUMBER VARCHAR(16777216),
	VISIT_ASSIGNING_AUTHORITY VARCHAR(16777216),
	ADMIT_DT_RAW VARCHAR(16777216),
	DISCHARGE_DT_RAW VARCHAR(16777216),
	ADMIT_DT_TZ TIMESTAMP_TZ(9),
	DISCHARGE_DT_TZ TIMESTAMP_TZ(9)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_BRONZE_RAW (
	FILENAME VARCHAR(16777216),
	FILE_ROW_NUMBER NUMBER(38,0),
	SEGMENT_TYPE VARCHAR(16777216),
	LINE VARCHAR(16777216),
	LOAD_TS TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.HL7_RAW_LINES (
	LINE VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.MAP_ALLERGEN_IUIS_TO_STD (
	IUIS_CODE_TEXT VARCHAR(16777216),
	NORMALIZED_DISPLAY VARCHAR(16777216),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	NOTES VARCHAR(16777216)
);
create or replace TABLE FINAL_ASSIGNMENT.HL7.MAP_PATIENT_ID (
	MPI_ID VARCHAR(16777216) NOT NULL DEFAULT UUID_STRING(),
	HL7_PATIENT_ID VARCHAR(16777216),
	CSV_PATIENT_ID VARCHAR(16777216),
	CONFIDENCE_SCORE NUMBER(5,2),
	MATCH_METHOD VARCHAR(16777216),
	IS_ACTIVE BOOLEAN DEFAULT TRUE,
	primary key (MPI_ID)
);
create or replace view FINAL_ASSIGNMENT.HL7.HL7_BRONZE_BASE(
	FILENAME,
	FILE_ROW_NUMBER,
	SEGMENT_TYPE,
	LINE,
	MESSAGE_ID,
	PROCESS_TS
) as
SELECT
  FILENAME,
  FILE_ROW_NUMBER,
  SEGMENT_TYPE,
  LINE,
  LAST_VALUE(
    CASE WHEN SEGMENT_TYPE = 'MSH' THEN SPLIT_PART(LINE, '|', 10) END
  ) IGNORE NULLS
  OVER (
    PARTITION BY FILENAME
    ORDER BY FILE_ROW_NUMBER
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS MESSAGE_ID,
  CURRENT_TIMESTAMP() AS PROCESS_TS
FROM HL7_BRONZE_RAW;
create or replace view FINAL_ASSIGNMENT.HL7.V_HL7_IUIS_NORMALIZED(
	MPI_ID,
	PATIENT_SOURCE_ID,
	IUIS_CODE_TEXT,
	NORMALIZED_DISPLAY
) as
SELECT
  r.MPI_ID,
  r.PATIENT_SOURCE_ID,
  r.ALLERGEN_RAW AS IUIS_CODE_TEXT,
  COALESCE(m.NORMALIZED_DISPLAY,
    CASE
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Der\\s?[fp]\\s?\\d', 'i') THEN 'House dust mite (organism)'
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Ara\\s?h\\s?\\d',   'i')  THEN 'Peanut (substance)'
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Can\\s?f\\s?\\d',  'i')  THEN 'Animal dander (substance)'
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Jug\\s?r\\s?\\d',  'i')  THEN 'Tree nut (substance)'
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Che\\s?a\\s?\\d',  'i')  THEN 'Tree nut (substance)'
      WHEN REGEXP_LIKE(r.ALLERGEN_RAW, '^Pen\\s?n\\s?\\d',  'i')  THEN 'Mold (organism)'
      ELSE 'Allergy to substance (finding)'
    END
  ) AS NORMALIZED_DISPLAY
FROM HL7.FACT_ALLERGY_EVENT_HL7_RAW r
LEFT JOIN HL7.MAP_ALLERGEN_IUIS_TO_STD m
  ON LOWER(m.IUIS_CODE_TEXT) = LOWER(r.ALLERGEN_RAW);
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.HL7.HL7_BRONZE_FF
	FIELD_DELIMITER = '\t'
	NULL_IF = ('', 'NULL')
;
create or replace pipe FINAL_ASSIGNMENT.HL7.HL7_PIPE auto_ingest=true as COPY INTO HL7_BRONZE_RAW (FILENAME, FILE_ROW_NUMBER, SEGMENT_TYPE, LINE, LOAD_TS)
  FROM (
    SELECT
      METADATA$FILENAME,
      METADATA$FILE_ROW_NUMBER,
      SPLIT_PART($1, '|', 1),   -- MSH/PID/PV1/...
      $1,
      CURRENT_TIMESTAMP()
    FROM @HL7_STAGE (FILE_FORMAT => HL7_BRONZE_FF)
  )
  FILE_FORMAT = (FORMAT_NAME = HL7_BRONZE_FF)
  ON_ERROR = 'CONTINUE'
  PATTERN = '.*\\.(hl7|txt)$';
create or replace schema FINAL_ASSIGNMENT.MART;

create or replace TABLE FINAL_ASSIGNMENT.MART.FACT_ALLERGY_EVENT (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	ALLERGEN_SK NUMBER(38,0),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.MART.FACT_ALLERGY_EVENT_CSV (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	ALLERGEN_SK NUMBER(38,0),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.MART.FACT_ALLERGY_EVENT_HL7 (
	MPI_ID VARCHAR(16777216),
	PATIENT_SOURCE_ID VARCHAR(16777216),
	ALLERGEN_SK NUMBER(38,0),
	STANDARD_SYSTEM VARCHAR(16777216),
	STANDARD_CODE VARCHAR(16777216),
	STANDARD_DISPLAY VARCHAR(16777216),
	CATEGORY VARCHAR(16777216),
	SEVERITY VARCHAR(8),
	REACTION_TEXT VARCHAR(16777216),
	SOURCE_SYSTEM VARCHAR(3)
);
create or replace TABLE FINAL_ASSIGNMENT.MART.MAP_PATIENT_ID (
	MPI_ID VARCHAR(16777216) NOT NULL DEFAULT UUID_STRING(),
	HL7_PATIENT_ID VARCHAR(16777216),
	CSV_PATIENT_ID VARCHAR(16777216),
	CONFIDENCE_SCORE NUMBER(5,2),
	MATCH_METHOD VARCHAR(16777216),
	IS_ACTIVE BOOLEAN DEFAULT TRUE,
	primary key (MPI_ID)
);
create or replace schema FINAL_ASSIGNMENT.PUBLIC;

CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.PUBLIC.HL7_BRONZE_FF
	FIELD_DELIMITER = '\t'
	NULL_IF = ('', 'NULL')
;
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.PUBLIC.HL7_FF
	FIELD_DELIMITER = '|'
	NULL_IF = ('', 'NULL')
;
CREATE OR REPLACE FILE FORMAT FINAL_ASSIGNMENT.PUBLIC.PARQUET_FF
	TYPE = PARQUET
	NULL_IF = ()
;
create or replace pipe FINAL_ASSIGNMENT.PUBLIC.CCDA_PIPE auto_ingest=true as COPY INTO FINAL_ASSIGNMENT.CCDA.CCDA_BRONZE (FILE_NAME, DOC)
FROM (
  SELECT METADATA$FILENAME, PARSE_XML($1)            
  FROM @FINAL_ASSIGNMENT.CCDA.CCDA_XML_STAGE
  ( FILE_FORMAT => FINAL_ASSIGNMENT.CCDA.FF_XML, PATTERN => '.*\.xml' )
)
ON_ERROR = 'CONTINUE';
create or replace schema FINAL_ASSIGNMENT.SILVER;

create or replace TABLE FINAL_ASSIGNMENT.SILVER.IMMUNIZATION_UNION (
	PATIENT_ID VARCHAR(16777216),
	ENCOUNTER_ID VARCHAR(16777216),
	IMM_DATE DATE,
	IMM_TS TIMESTAMP_NTZ(9),
	CODE VARCHAR(16777216),
	CODE_SYSTEM VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	ORGANIZATION_ID VARCHAR(16777216),
	PROVIDER_ID VARCHAR(16777216),
	GENDER VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216)
);